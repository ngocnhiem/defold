name: CI - Bisect

on:
  push:
    branches-ignore:
      - 'skip-ci-*'
      - 'DEFEDIT-*'
      - 'editor-dev'
  repository_dispatch:
    types: [bisect]

env:
  BUILD_BRANCH: ${{ github.event.client_payload.branch }}
  DM_PACKAGES_URL: ${{ secrets.DM_PACKAGES_URL }}
  BISect_START_INDEX: '88'

jobs:
  bld-eng-windows:
    strategy:
      matrix:
        platform: [x86_64-win32]

    runs-on: windows-latest
    if: github.event_name != 'repository_dispatch' || github.event.action == 'bisect'
    steps:
      - name: 'Checkout'
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: '${{env.BUILD_BRANCH}}'
          fetch-depth: 0
      - name: 'Install Python'
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c
        with:
          python-version: 3.12
      - name: 'Install Java'
        uses: actions/setup-java@99b8673ff64fbf99d8d325f52d9a5bdedb8483e9
        with:
          java-version: '17.0.5+8'
          distribution: 'temurin'
      - name: 'Setup dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'
          dotnet-quality: 'preview'
      - name: 'Install dependencies'
        shell: bash
        run: 'ci/ci.sh install --platform=${{ matrix.platform }}'
      - name: 'Build range'
        if: (github.event_name != 'repository_dispatch') || ((github.event_name == 'repository_dispatch') && (github.event.client_payload.skip_engine != true))
        shell: bash
        run: |
          set -e
          export DYNAMO_HOME="$GITHUB_WORKSPACE/tmp/dynamo_home"
          mkdir -p "$DYNAMO_HOME"
          export PYTHONPATH="$GITHUB_WORKSPACE/build_tools:$DYNAMO_HOME/ext/lib/python"
          git fetch --tags --force
          commits=$(git rev-list --reverse 1.9.5..1.9.6)
          if [ -z "$commits" ]; then
            echo "No commits found between 1.9.5 and 1.9.6" >&2
            exit 1
          fi
          start_idx="${BISect_START_INDEX:-0}"
          echo "Starting from index: $start_idx"

          mkdir -p artifacts
          idx=0
          summary="$GITHUB_STEP_SUMMARY"
          echo "Bisect build artifacts" >> "$summary"
          start_time=$(date +%s)
          max_seconds=$((340*60))

          python scripts/build.py distclean install_sdk install_ext check_sdk --platform=${{ matrix.platform }}
          cat > "$RUNNER_TEMP/skip_sdk_tests_patch.py" <<'PY'
          #!/usr/bin/env python3
          import pathlib
          import sys

          path = pathlib.Path('engine/sdk/src/test/wscript')
          text = path.read_text(encoding='utf-8')

          if 'Options.options.skip_build_tests' in text:
              sys.exit(0)

          text = text.replace('from waflib import Options\\n', 'from waflib import Options\n')

          lines = text.splitlines(keepends=True)

          if 'from waflib import Options\n' not in lines:
              insert_at = 0
              for i, line in enumerate(lines):
                  if line.startswith('import ') or line.startswith('from '):
                      insert_at = i + 1
                  else:
                      break
              lines.insert(insert_at, 'from waflib import Options\n')

          def_index = None
          for i, line in enumerate(lines):
              if line.startswith('def build('):
                  def_index = i
                  break
          if def_index is None:
              raise SystemExit('build() not found in engine/sdk/src/test/wscript')

          indent = '    '
          lines.insert(def_index + 1, f'{indent}if Options.options.skip_build_tests:\n')
          lines.insert(def_index + 2, f'{indent}{indent}return\n')

          path.write_text(''.join(lines), encoding='utf-8')
          PY
          cat > "$RUNNER_TEMP/find_dmengine.py" <<'PY'
          #!/usr/bin/env python3
          import os
          import sys

          for root, _, files in os.walk('.'):
              if 'dmengine.exe' in files:
                  path = os.path.join(root, 'dmengine.exe').replace('\\', '/')
                  print(path)
                  sys.exit(0)
          sys.exit(1)
          PY

          retry_build() {
            local attempts=$1
            shift
            local n=1
            while true; do
              "$@" && return 0
              if [ $n -ge $attempts ]; then
                return 1
              fi
              echo "Build failed, retrying ($n/$attempts)..."
              sleep 3
              n=$((n + 1))
            done
          }

          for sha in $commits; do
            echo "=== Building $idx $sha ==="
            now=$(date +%s)
            if [ $((now - start_time)) -ge $max_seconds ]; then
              echo "Time budget reached, stopping at index $idx" >> "$summary"
              echo "Stopping due to time budget at index $idx"
              break
            fi
            if [ "$idx" -lt "$start_idx" ]; then
              echo "Skipping $idx"
              idx=$((idx + 1))
              continue
            fi
            git checkout -f "$sha"
            python "$RUNNER_TEMP/skip_sdk_tests_patch.py"

            python scripts/build.py install_ext --platform=${{ matrix.platform }}
            retry_build 3 python scripts/build.py build_engine --platform=${{ matrix.platform }} --skip-tests --skip-docs --skip-builtins -- --skip-build-tests

            exe=$(python "$RUNNER_TEMP/find_dmengine.py")
            if [ -z "$exe" ]; then
              echo "dmengine.exe not found for $sha" >&2
              exit 1
            fi

            short=$(git rev-parse --short=12 HEAD)
            name="${idx}-${short}.exe"
            cp "$exe" "artifacts/$name"
            echo "$idx $sha $name" >> artifacts/manifest.txt
            echo "- $name ($sha)" >> "$summary"
            idx=$((idx + 1))
          done
      - name: 'Upload artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'bisect-artifacts'
          path: 'artifacts'
