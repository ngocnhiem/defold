name: CI - Bisect

on:
  push:
    branches-ignore:
      - 'skip-ci-*'
      - 'DEFEDIT-*'
      - 'editor-dev'
  repository_dispatch: {}

env:
  BUILD_BRANCH: ${{ github.event.client_payload.branch }}
  DM_PACKAGES_URL: ${{ secrets.DM_PACKAGES_URL }}

jobs:
  bld-eng-windows:
    strategy:
      matrix:
        platform: [x86_64-win32]

    runs-on: windows-latest
    steps: [
      { name: 'Checkout', uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11, with: { ref: '${{env.BUILD_BRANCH}}', fetch-depth: 0 } },
      { name: 'Install Python', uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c, with: { python-version: 3.12} },
      { name: 'Install Java', uses: actions/setup-java@99b8673ff64fbf99d8d325f52d9a5bdedb8483e9, with: { java-version: '17.0.5+8', distribution: 'temurin'} },
      { name: 'Setup dotnet', uses: actions/setup-dotnet@v4, with: {dotnet-version: '9.x', dotnet-quality: 'preview'}},
      { name: 'Install dependencies', shell: bash, run: 'ci/ci.sh install --platform=${{ matrix.platform }}' },
      {
        name: 'Build range',
        if: (github.event_name != 'repository_dispatch') || ((github.event_name == 'repository_dispatch') && (github.event.client_payload.skip_engine != true)),
        shell: bash,
        run: |
          set -e
          git fetch --tags --force
          commits=$(git rev-list --reverse 1.9.5..1.9.6)
          if [ -z "$commits" ]; then
            echo "No commits found between 1.9.5 and 1.9.6" >&2
            exit 1
          fi

          mkdir -p artifacts
          idx=0
          summary="$GITHUB_STEP_SUMMARY"
          echo "Bisect build artifacts" >> "$summary"

          for sha in $commits; do
            echo "=== Building $idx $sha ==="
            git checkout -f "$sha"

            if [ "$idx" -eq 0 ]; then
              python scripts/build.py distclean install_sdk install_ext check_sdk build_engine --platform=${{ matrix.platform }} --skip-tests --skip-docs --skip-builtins
            else
              python scripts/build.py distclean build_engine --platform=${{ matrix.platform }} --skip-tests --skip-docs --skip-builtins
            fi

            exe=$(python - <<'PY'
import os
for root, _, files in os.walk("."):
    if "dmengine.exe" in files:
        path = os.path.join(root, "dmengine.exe").replace("\\\\", "/")
        print(path)
        break
PY
)
            if [ -z "$exe" ]; then
              echo "dmengine.exe not found for $sha" >&2
              exit 1
            fi

            short=$(git rev-parse --short=12 HEAD)
            name="${idx}-${short}.exe"
            cp "$exe" "artifacts/$name"
            echo "$idx $sha $name" >> artifacts/manifest.txt
            echo "- $name ($sha)" >> "$summary"
            idx=$((idx + 1))
          done
      },
      {
        name: 'Upload artifacts',
        if: always(),
        uses: actions/upload-artifact@v4,
        with: { name: 'bisect-artifacts', path: 'artifacts' }
      }
    ]
